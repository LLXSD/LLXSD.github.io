<!DOCTYPE html>

<html class="theme-next mist use-motion" lang="zh-CN">

<!-- body -->
<head><meta name="generator" content="Hexo 3.8.0">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


<link rel="stylesheet" href="/assets/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">
<link rel="stylesheet" href="/assets/css/main-post.css?v=7.0.0">
<link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">

<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>

<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

<!-- title -->
<title> Formal Analysis of Access Control Mechanism of 5G Core Network</title>
  
  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
</head>

<!-- body -->

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

<!-- 可能是显示相关设置 -->
<div class="container sidebar-position-left page-post-detail">
<div class="headband"></div>
<header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-inner"><div class="site-brand-wrapper">
    <div class="site-meta">
    <div class="custom-logo-site-title">
        <a href="/" class="brand" rel="start">
            <span class="logo-line-before"><i></i></span>
            <span class="site-title">Lixin's Blog</span>
            <span class="logo-line-after"><i></i></span>
        </a>
    </div>
    </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<!-- 导航栏 -->
<nav class="site-nav">
    <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
            <a href="/blogs/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
        
        <li class="menu-item menu-item-tags">
            <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
        
        <li class="menu-item menu-item-categories">
            <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
        
        <!-- <li class="menu-item menu-item-archives">
            <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li> -->

        <!-- <li class="menu-item menu-item-search">
            <a href="javascript:;" class="popup-trigger">
                <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li> -->
    </ul>

<!-- <div class="site-search">   
    <div class="popup search-popup local-search-popup">
        <div class="local-search-header clearfix">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
            <div class="local-search-input-wrapper">
                <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
            </div>
        </div>
        <div id="local-search-result"></div>
    </div>
</div>   -->

</nav>

</div>
</header>
<!-- 导航栏结束 -->
    
<main id="main" class="main">
<div class="main-inner">
<div class="content-wrap">
    <div id="content" class="content">
    <div id="posts" class="posts-expand">
    <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/Bioinfo-ML-Club-7th/">
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lixin's Blog">
    </span>

<!-- 页面内标题 -->
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline"> Formal Analysis of Access Control Mechanism of 5G Core Network </h1>
        <div class="post-meta">
            <span class="post-time">
                <span class="post-meta-item-icon">
                    <i class="fa fa-calendar-o"></i>
                </span>
                <span class="post-meta-item-text">发表于</span>
                <time itemprop="dateCreated datePublished">2023-11-30</time>
            </span>
            <span class="post-category">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                    <i class="fa fa-folder-o"></i>
                </span>
                <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Mobile-Network/" itemprop="url" rel="index"><span itemprop="name">Measurement</span></a></span>
            </span>
        </div>
    </header>
    
<div class="post-body" itemprop="articleBody">
<!-- 文章内容开始 -->
<h1 id="summary">SUMMARY</h1>
<p>本文主要讨论了5G核心网络access control的形式化分析，关注NF向NRF请求token，并向其他NF请求服务的过程。
文章提出5GCVerif工具对5G核心网络的访问控制策略进行了形式化验证，定义了4种安全属性，发现了5种可能的安全隐患，提出一些简单的防御措施。</p>
<h1 id="motivation">Motivation</h1>
<p>5GC以更分散的NF提供服务，NF维护关于UE和5G系统的敏感信息，NF的resource
allocation和authorization是非常重要的。
3GPP采用了OAuth 2.0框架作为5GC内NF访问控制的基础，但是目前没有工作对改框架做形式化认证，文章尝试回答如下问题：
<strong>Is it possible to formally analyze the design of OAuth-based access control mechanism of a 5G Core?</strong></p>
<p>文章认为虽然已有工作分析了4G/5G协议安全性，但是存在以下缺陷：</p>
<ul>
<li>Some approaches have modeled only a single NF (i.e., MME/AMF) as the interface of 5GC by combining all NFs’ functionalities into one. This prevents reasoning about the <strong>interactions between NFs</strong>.</li>
<li>Other methods only model and analyze a subset of the protocol interactions, and quickly run into intractability and scalability issues when faced with more intricate protocol interactions.
<ul>
<li>Additionally, these analyses require manual interventions from human experts to guide the provers, making them <strong>less automated and unmanageable for large systems</strong>.</li>
<li>Moreover, all preceding approaches treat the 5G core network configurations as static, <strong>not accounting for changes during network operations</strong>. However, 5GC permits dynamic configuration updates.</li>
</ul>
</li>
</ul>
<h1 id="challenges">Challenges</h1>
<ul>
<li>Incomplete and non-compliant open-source core: 不同实现可能有区别，所以文章基于标准进行分析；</li>
<li>Intractability: 5GC中包含大量的NF，service和operation，并且耦合了动态更新和复杂的授权逻辑，分析的难度大、状态空间爆炸；</li>
<li>Ambiguity and underspecification: 标准描述模糊，存在定义不清晰的地方。</li>
</ul>
<p>文章将问题归为model-checking问题。
However, the highly configurable and customizable nature of the 5G Core turns the problem into an <strong>undecidable parameterized model-checking problem</strong>.</p>
<ul>
<li>5GC太复杂了，采用cutoff原则和small model theorem只分析5个NF规模下的表现；</li>
<li>遍历所有可能的配置不可行，随机构造符合规范的配置；</li>
<li>利用符号匹配的方法，迭代寻找配置不满足安全特性的地方。</li>
</ul>
<h1 id="back">Background</h1>
<p>A <strong>Network Repository Function (NRF)</strong> allows other NFs to register and discover each other, and is the main focus of this study. The Access and Mobility Management Function (AMF) provides UE registration, connection, and reachability management. The Unified Data Repository (UDR) provides storage for subscriber and policy-related data. The Unified Data Management (UDM) accesses UDR and manages user identity and generates authentication credentials.</p>
<p>OAuth 2.0 is a well-established framework to govern authorization in a virtualized system. It is based on a central authorization server that issues access tokens to clients to grant access for invoking API calls. In a 5G Core, <strong>the NRF plays the role of the authorization server</strong>.</p>
<p>NF间交互的基本过程如下：</p>
<p><img src="/images/blogs/paper/cellular security-access control-interaction.png" alt="图片" /></p>
<blockquote>
<p>A valid accessTokenRequest includes the consumer’s NFInstanceID, the target service and the corresponding scopes it wishes to access, the NFInstanceID or NFType of the NFP, etc.</p>
</blockquote>
<h1 id="design">Design</h1>
<p><img src="/images/blogs/paper/cellular security-access control-architecture.png" alt="图片" /></p>
<p><strong>5GCVerif包括以下几个步骤：</strong></p>
<ul>
<li>模型构建：首先，构建一个抽象模型M*，该模型由一组通过认证通信通道进行通信的有限状态机（FSM）组成。M* 抽象了3GPP Release 17 技术规范中定义的5G Core访问控制机制。</li>
<li>NF更新：操作管理（OAM）决定NF是否能够成功更新其配置文件。在模型中，允许更新的属性由一组控制参数控制。</li>
<li>NF注册：NF在网络中注册并获取唯一标识符。</li>
<li>NF发现：在5G Core中，消费者NF通过发送NFDiscoveryRequest消息来发现生产者NF。</li>
<li>授权逻辑：实施授权逻辑时，需要根据授权参数验证请求。授权参数可能包括允许的网络切片、允许的NF类型等。</li>
<li>模型检查过程：在此步骤中，使用符号模型检查器（如nuXmv）来验证M是否满足访问控制属性Φ。如果找到了一个反例，则表明5GC的访问控制策略存在漏洞。</li>
<li>安全属性：将访问控制策略分解为多个简单属性，每个属性仅关注一个授权参数。这有助于简化漏洞的识别和根源分析。</li>
</ul>
<p><img src="/images/blogs/paper/cellular security-access control-property.png" alt="图片" /></p>
<p><strong>每个步骤的关键设计点如下：</strong></p>
<ul>
<li>模型构建：在构建抽象模型时，需要确保模型能够捕捉到5G Core访问控制机制的核心特征，同时还要考虑可扩展性和可定制性。</li>
<li>NF更新：在设计模型时，需要考虑如何有效地控制允许更新的属性，以便在模型中分析不同的配置文件更新场景。</li>
<li>NF注册：需要确保在模型中正确地实现NF注册的过程，以便在网络中正确地识别和管理各个NF。</li>
<li>NF发现：在实现NF发现过程时，需要考虑如何处理不同的NF之间的通信，以及如何在模型中实现这些通信。</li>
<li>授权逻辑：实现授权逻辑时，需要考虑如何在SMV语言中实现复杂的条件语句，例如使用决策表或if-else结构。</li>
</ul>
<h1 id="findings">Findings</h1>
<p>文章发现了以下几类可能的漏洞，并进行了验证：</p>
<p><img src="/images/blogs/paper/cellular security-access control-finding.png" alt="图片" /></p>
<ul>
<li><strong>Confused Producer Attack</strong>：一个恶意消费者可以伪装成另一个消费者，从而使生产者无法正确验证权限。</li>
<li><strong>Token Reuse Attack</strong>：一个被攻击的消费者NF可以重用先前保存的未过期的访问令牌来访问原本不应该访问的受害者NF。</li>
<li><strong>Default Overprivilege Attack</strong>：在OAM（操作维护）存在的情况下，它需要批准攻击者删除其sNssais。这可能导致攻击者获得更多权限。</li>
<li><strong>Authorization Bypass Attack</strong>：NRF（网络功能实例注册）在处理NFDiscoveryRequest时，未对NFDiscoveryRequest和消费者NFProfile的权限参数进行交叉检查，可能导致未经授权的访问。</li>
<li><strong>Parameter Misuse Attack</strong>：一旦被攻击的消费者NF在合法切片中获得对生产者NF的访问令牌，它也会隐含地被授予访问同一NF内其他切片中的相同操作。攻击者只需提供相应的查询参数，即可从他们不应访问的切片中检索、创建或更改信息。</li>
</ul>
<h1 id="discussion">Discussion</h1>
<ul>
<li><strong>Confused Producer Attack</strong>：accessToken已经包含一个属性producerSnssaiList，该属性指定了消费者有权访问的sNssais列表。NFP可以使用此列表来验证消费者是否被允许访问其服务，以防止困惑的生产者攻击。然而，3GPP定义了producerSnssaiList是可选的，因此NFP不能依赖此属性来验证消费者的授权。我们建议在accessToken中强制加入producerSnssaiList。</li>
<li><strong>Token Reuse Attack</strong>：目前，OAuth 2.0令牌没有描述撤销机制。一个合理的解决方案是启用NFP来检查NFC是否使用过时的accessToken。为此，NFP可以在从NFC接收 NFServiceRequest时通过新的API调用TokenVerificationRequest(accessToken) 查询NRF。RFC 7662中也讨论了类似的解决方案。然而，为每个NFServiceRequest引入NFP和NRF之间的额外网络交互可以显着提高NRF和NFP的性能，并击败缓存accessToken 的目的。另一种解决方案是向accessToken引入新的属性时间戳，它表示发行时间。此外，NFP 应该维护一个属性lastUpdateTime，以跟踪最近的关键NFProfile更新。如果accessToken中的时间戳比NFP的lastUpdateTime更早，NFP将拒绝 NFServiceRequest。</li>
<li><strong>Default Overprivilege Attack</strong>：为了减轻这种攻击，OAM必须在授予配置文件更新之前验证对关键NFProfile属性的更新。此外，在每个accessTokenRequest中NRF应该根据NFC的NFProfile中的相关属性验证NFP的NFProfile的授权参数。避免所有关键属性的允许默认策略也很重要，包括sNsais。相反，应该强制执行deny-bydefault 策略。但是，如果各方没有都修复，实施此修复可能会导致互操作性问题。</li>
<li><strong>Authorization Bypass Attack</strong>：在NRF验证NFDiscoveryRequest期间，强制在请求者ssaisnfDisc消息和sNs之间执行交叉检查。</li>
<li><strong>Parameter Misuse Attack</strong>：一种方法是NRF在accessTokenRequest验证期间检查输入参数，并且只将验证值附加到accessToken。然而，这种方法需要对现有的accessToken设计进行重大修改，并可能导致系统开销增加。它还限制了accessToken缓存，并可能导致通信瓶颈。或者，如果NFP 进行验证，NFP将需要有关NFC（例如 NFProfile）的附加信息，并且可能需要对NRF进行额外的查询，从而导致大量延迟。</li>
</ul>
<p>作者与GSMA分享了这些findings，并且获得CVD-2023-0069编号。</p>
<p>Link to paper: <a href="https://dl.acm.org/doi/abs/10.1145/3576915.3623113">Formal Analysis of Access Control Mechanism of 5G Core Network</a></p>

<!-- 文章内容最后 -->
</div>

<footer class="post-footer">
    <!-- 标签信息 -->
    <div class="post-tags">
        <a href="/tags/Security" rel="tag"># Security</a>
        <a href="/tags/Mobile Network" rel="tag"># Mobile Network</a>
    </div>
    <!-- 文章信息 -->
    <div class="post-nav">
        <!-- 上一篇 -->
        <div class="post-nav-next post-nav-item">
            <a href="/blogs/paper/2023/11/23/" rel="next" title="Making Sense of Constellations">
                <i class="fa fa-chevron-left"></i> Making Sense of Constellations
            </a>
        </div>
        <!-- 下一篇 -->
        <span class="post-nav-divider"></span>
        <div class="post-nav-prev post-nav-item">
            <!-- <a href="/2019/05/05/Understand-Variants-Calling/" rel="prev" title="深入理解基因组变异检测(variants calling)">
              深入理解基因组变异检测(variants calling) <i class="fa fa-chevron-right"></i>
            </a> -->
        </div>
    </div>
</footer>

</div>
</article>

</div>
</div>
<!-- github comments -->
    <!-- <div class="comments" id="comments">
        <div id="gitment-container"></div>
    </div> -->
    
</div>
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>


 <!-- 右侧边栏开始 --> 
<aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

 <!-- 右侧边栏内容 -->    
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li>
          <!-- <li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li> -->
        </ul>
      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            <!-- 目录 -->
            <div class="post-toc-content">
                <ol class="nav">
                    <li class="nav-item nav-level-1">
                        <a class="nav-link" href="#summary">
                            <span class="nav-text">SUMMARY</span>
                        </a>
                    </li>
                    
                    <li class="nav-item nav-level-1">
                        <a class="nav-link" href="#motivation">
                            <span class="nav-text">Motivation</span>
                        </a>
                    </li>

                    <li class="nav-item nav-level-1">
                        <a class="nav-link" href="#challenges">
                            <span class="nav-text">Challenges</span>
                        </a>
                    </li>

                    <li class="nav-item nav-level-1">
                        <a class="nav-link" href="#back">
                            <span class="nav-text">Background</span>
                        </a>
                    </li>

                    <li class="nav-item nav-level-1">
                        <a class="nav-link" href="#design">
                            <span class="nav-text">Design</span>
                        </a>
                    </li>

                    <li class="nav-item nav-level-1">
                        <a class="nav-link" href="#findings">
                            <span class="nav-text">Findings</span>
                        </a>
                    </li>

                    <li class="nav-item nav-level-1">
                        <a class="nav-link" href="#discussion">
                            <span class="nav-text">Discussion</span>
                        </a>
                    </li>
                </ol>
            </div>
          </div>
        </div>
      <!--/noindex-->

<!-- 右侧边栏结束 --> 
    </div>
</aside>


        
      </div>
    </main>

<!-- 页面最下方的描述 -->

<!-- <footer id="footer" class="footer">
    <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
        <span class="with-love" id="animate">
            <i class="fa fa-user"></i>
        </span>
        <span class="author" itemprop="copyrightHolder">Lianm</span>
        </div>
        <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>
        <span class="post-meta-divider">|</span>
        <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.0.0</div>
    </div>
</footer> -->

<!-- 返回顶部 -->
<div class="back-to-top">
    <i class="fa fa-arrow-up"></i>        
</div>
      
</div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>



  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/assets/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/assets/lib/jquery/index.js?v=2.1.3"></script>
  <script src="/assets/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/assets/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  <script src="/assets/lib/three/three.min.js"></script>
  <script src="/assets/lib/three/three-waves.min.js"></script>
  <script src="/assets/js/src/utils.js?v=7.0.0"></script>
  <script src="/assets/js/src/motion.js?v=7.0.0"></script>
  <script src="/assets/js/src/schemes/muse.js?v=7.0.0"></script>
  <script src="/assets/js/src/scrollspy.js?v=7.0.0"></script>
  <script src="/assets/js/src/post-details.js?v=7.0.0"></script>
  <script src="/assets/js/src/bootstrap.js?v=7.0.0"></script>


    <!-- LOCAL: You can save these files to your site and update links -->

  
  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
<!-- END LOCAL -->

<!-- github comment -->
<!-- <style>
#gitment-container a {
  border-bottom: none;
}

</style>

<script>
  function renderGitment() {
    var gitment = new Gitment({
      id: window.location.pathname,
      owner: 'Ming-Lian',
      repo: 'Gitment-repo',
      
      oauth: {
      
      
        client_secret: '3dc34ff32bbb0ee876b487f13a800b08857e0a10',
      
        client_id: '0e14870b1fb232903713'
      }
    });
    gitment.render('gitment-container');
  }

  
    renderGitment();
  
</script> -->

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>


  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'; 
      }
      else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>

</body>
</html>
